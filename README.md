# Google reCAPTCHA

This repository contains a sample code using Google's reCAPTCHA.

Using reCAPTCHA is quite simple:

- Include reCAPTCHA scripts in your webpage
- Tag a button with reCAPTCHA, with `data-sitekey` attribute set
- Have a service receive the request sent from the page
- Add a call to Google's service to check whether that information reCAPTCHA
  sent is valid, and if it is a bot or not.

There is a more complete documentation [here](https://www.google.com/recaptcha).

## Run App
- Run frontend code from root directory
  - `cd frontend`
  - `npm run build && npm run dev`
- Run backend code from root directory
  - `cd backend`
  - `node index.js`

## Quick and dirty

### 1. Add reCAPTCHA script and add a callback function

```html
  <script src="https://www.google.com/recaptcha/api.js"></script>
  <script type="text/javascript">
    function submitForm(token) {
      document.getElementById("registrationForm").submit();

    }
  </script>
```

Really simple. This code defined a function `submitForm` which will take
whatever element `registrationForm` contains and submit it. The server
(for this example) is defined in the form itself.

### 2. Add a button

```html
  <form action="http://localhost:3000/user" method="POST" id="registrationForm">
    ...
    <button class="g-recaptcha" 
        data-sitekey="YOUR SITE KEY HERE" 
        data-callback='submitForm' 
        data-action='submit'>Submit</button>
  </form>
```

This will create a form and will add a button to it. Notice the `YOUR SITE KEY HERE`
attribute. This should be, your site key.

### 3. Add reCAPTCHA verification to your backend
  
This is simpler than it sound. Basically, send a POST HTTP request to `https://www.google.com/recaptcha/api/siteverify` with data received from the request (by default it should be
`g-recaptcha-response`, but it can have another names. It should be the
token generated by reCAPTCHA library) and your secret key (which you got when
you created the site key). This request should look like this (I'm using axios
here):

```javascript
  const config = {
    method: 'post',
    url: 'https://www.google.com/recaptcha/api/siteverify',
    params: {
      secret: "YOUR SECRET KEY HERE",
      response: req.body["g-recaptcha-response"]
    }
  }
  console.log(`Request data: ${util.inspect(config)}`)
  axios(config).then((status) => {
    console.log(`Received response from Google: ${util.inspect(status.data)}`);
    if (data.success === true) {
      res.status(200).send({'message': 'ok'});
    } else {
      res.status(405).send({'message': 'not-allowed'});
    }
  }).catch((error) => {
    console.log(`Received error from Google: ${error}`);
    res.status(500).send({'message': 'error'});
  });
```

Notice that the response contains an attribute `success` which should be the
trigger to let the request be processed (`true` indicates that the service
thinks that the user is a human - poor thing -, `false` it should be a bot).

## Steps

Useful diagrams of spike
https://cloud.google.com/static/recaptcha-enterprise/images/sequence_diagramv1.svg

https://cloud.google.com/static/recaptcha-enterprise/images/flowchart.svg

Docs
https://cloud.google.com/recaptcha-enterprise/docs/choose-key-type ->  Score-based site key (Recommended)

Steps
- I enabled recaptcha enterprise API using steps found here -> https://cloud.google.com/recaptcha-enterprise/docs/set-up-non-google-cloud-environments-api-keys
  https://console.cloud.google.com/apis/library/recaptchaenterprise.googleapis.com?_ga=2.149945471.831651267.1659344202-1298407974.1659344202

- I created API Key after selecting a project-> ******
  https://console.cloud.google.com/apis/credentials?project=trans-falcon-358109

- I selected Setting up reCAPTCHA Enterprise on non-Google Cloud environments using API Keys as my setup method

I selected the type of reCaptcha keys as per -> https://cloud.google.com/recaptcha-enterprise/docs/keys *Score-based site keys* on *web*

- I created reCaptcha/site keys using the steps here. I added localhost as an allowed domain -> https://cloud.google.com/recaptcha-enterprise/docs/create-key#creating_a_site_key
  https://console.cloud.google.com/security/recaptcha?_ga=2.81392350.831651267.1659344202-1298407974.1659344202&project=trans-falcon-358109
  reCaptcha/site keys -> ******

- I installed score-based site keys (no challenge) on the website using steps here -> https://cloud.google.com/recaptcha-enterprise/docs/instrument-web-pages

Integration
- Integrate the key with the frontend https://cloud.google.com/recaptcha-enterprise/docs/instrument-web-pages#frontend_integration_score
  - Add reCAPTCHA on an HTML button <- Option I used
  - Using deets from https://console.cloud.google.com/security/recaptcha/******/details?project=******
- Assess the reCAPTCHA response token https://cloud.google.com/recaptcha-enterprise/docs/create-assessment
  - Third-party cloud or on-premises that do not support service accountsâ€¦..reCAPTCHA Enterprise REST API, using API keys for authentication
  - Verify the reposes using -> https://developers.google.com/recaptcha/docs/v3